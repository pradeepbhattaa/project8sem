<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token }}" />
  <title>Vote Here</title>
  {% load static %}
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />
  <link rel="stylesheet" href="{% static 'myapp/css/nav.css' %}" />
  <link rel="stylesheet" href="{% static 'myapp/css/footer.css' %}" />
  <link rel="stylesheet" href="{% static 'myapp/css/vote.css' %}" />
  <link rel="stylesheet" href="{% static 'myapp/css/alert.css' %}" />
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js" type="application/javascript"></script>

</head>
<body>
  {% if messages %}
  <div id="message-container">
    {% for message in messages %}
    <div class="alert {{ message.tags }}">
      <span class="closebtn" onclick="this.parentElement.style.display='none';"
        >×</span
      >
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <header>
    <nav>
      <div class="nav-left">
        <div class="menu-icon" onclick="openNav()">☰</div>
        <div class="logo">
          <img
            src="{% static 'myapp/images/logo.jpg' %}"
            alt="Logo"
            class="circular-logo"
          />
        </div>
      </div>
       <div class="nav-center" id="navLinks">
                    <a href="{% url 'home' %}">Home</a>
                    <a href="{% url 'candidates' %}">Candidates</a>
                    <a href="{% url 'notices' %}">Notices</a>
                    <a href="{% url 'vote' %}">Vote Here</a>
                    <a href="{% url 'verify_kyc' %}">Verify KYC</a>
                    <a href="{% url 'resultuser' %}">Results</a>
                    <a href="{% url 'contact' %}">Contact</a>
                </div>
                <div class="nav-right">
                    {% if user_full_name %}
                    <span class="user-full-name">{{ user_full_name }}</span>
                    {% if user_profile_picture %}
                    <img src="{{ user_profile_picture}}" alt="Profile Picture" class="profiles-picture"
                        onclick="toggleDropdown()">
                    {% else %}
                    <img src="{% static 'myapp/images/user_icon.png' %}" alt="Profiles Picture" class="profiles-picture"
                        onclick="toggleDropdown()">
                    {% endif %}
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="{% url 'edit_profile' %}">Edit Profile</a>
                        <a href="{% url 'user_logout' %}">Logout</a>
                    </div>
                    {% else %}
                    <a href="{% url 'userlogin' %}" class="login-button">LogIn</a>
                    {% endif %}
                </div>
            </nav>
        </header>

        <div class="side-menu" id="sideMenu">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <div id="sideNavLinks">
                <a href="{% url 'home' %}">Home</a>
                <a href="{% url 'candidates' %}">Candidates</a>
                <a href="{% url 'notices' %}">Notices</a>
                <a href="{% url 'vote' %}">Vote Here</a>
                <a href="{% url 'verify_kyc' %}">Verify KYC</a>
                <a href="{% url 'resultuser' %}">Results</a>
                <a href="{% url 'contact' %}">Contact</a>
            </div>
        </div>
  </div>
  <main>
	
    <section class="vote-section">
      <h1>Vote Here</h1>
	  <div id="voting-status-message" style="color: red; font-weight: bold; text-align: center;"></div>
<div id="voting-ended-message" style="display: none; color: red; font-weight: bold; text-align: center;">
  Voting has ended. Please check the <a href="{% url 'resultuser' %}">results page</a>.
</div>
      <form method="post" action="{% url 'submit_vote' %}" id="vote-form">
        {% csrf_token %}
        <div class="vote-container">
          {% if votestatus %}
          <section class="verification-message">
            <div class="kyc-message">
              <span><h3>You have already voted for the Candidates.</h3></span
              ><br />
              <div>
                <span><h4>Please wait for the result</h4></span>
              </div>
            </div>
          </section>
          {% elif kycreject %}
          <section class="verification-message">
            <div class="kyc-message">
              <span
                ><h3>Your KYC has been rejected. Please resubmit your KYC.</h3></span
              >
            </div>
            <div class="kyc-button">
              <a href="{% url 'update_kyc' %}" class="submit-kyc">Update KYC</a>
            </div>
          </section>
          {% elif kycrequest %}
          <section class="verification-message">
            <div class="kyc-message">
              <span><h3>Your KYC verification process is in progress.</h3></span>
            </div>
          </section>
          {% elif not user_verified %}
          <section class="verification-message">
            <div class="kyc-message">
              <span><h3>To vote, please verify your KYC first.</h3></span>
            </div>
            <div class="kyc-button">
              <a href="{% url 'verify_kyc' %}" class="submit-kyc">Submit KYC</a>
            </div>
          </section>
          {% else %}
          <div class="vote-group" id="webcam-section">
            <h2>Facial Verification</h2>
            <video id="webcam" width="320" height="240" autoplay></video>
            <canvas id="canvas" style="display: none;"></canvas>
           
            <input type="hidden" id="live-descriptor" name="live_descriptor" />
            <button type="button" id="verify-face-btn" class="next-btn">
              Verify Yourself
            </button>
          </div>
          <div class="vote-group">
            <h2>Vote for Member of Parliament</h2>
            <div class="candidate-list" id="mp-candidates">
              {% for candidate in mp_candidates %}
              <div class="candidate-card">
                <img src="{{ candidate.profile_picture.url }}" alt="Profile Picture" />
                <div class="details">
                  <h3>{{ candidate.first_name }} {{ candidate.last_name }}</h3>
                  <p><strong>Party: </strong>{{ candidate.political_party }}</p>
                  <p><strong>Position: </strong>{{ candidate.role }}</p>
                  <div class="radio-button">
                    <input
                      type="radio"
                      name="mp_vote"
                      value="{{ candidate.email }}"
                    /><strong>Vote</strong>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="vote-group">
            <h2>Vote for Mayor</h2>
            <div class="candidate-list" id="mayor-candidates">
              {% for candidate in mayor_candidates %}
              <div class="candidate-card">
                <img src="{{ candidate.profile_picture.url }}" alt="Profile Picture" />
                <div class="details">
                  <h3>{{ candidate.first_name }} {{ candidate.last_name }}</h3>
                  <p><strong>Party: </strong>{{ candidate.political_party }}</p>
                  <p><strong>Position: </strong>{{ candidate.role }}</p>
                  <div class="radio-button">
                    <input
                      type="radio"
                      name="mayor_vote"
                      value="{{ candidate.email }}"
                    /><strong>Vote</strong>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="vote-group">
            <h2>Vote for Deputy Mayor</h2>
            <div class="candidate-list" id="deputy-mayor-candidates">
              {% for candidate in deputy_mayor_candidates %}
              <div class="candidate-card">
                <img src="{{ candidate.profile_picture.url }}" alt="Profile Picture" />
                <div class="details">
                  <h3>{{ candidate.first_name }} {{ candidate.last_name }}</h3>
                  <p><strong>Party: </strong>{{ candidate.political_party }}</p>
                  <p><strong>Position: </strong>{{ candidate.role }}</p>
                  <div class="radio-button">
                    <input
                      type="radio"
                      name="deputy_mayor_vote"
                      value="{{ candidate.email }}"
                    /><strong>Vote</strong>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="vote-group">
            <h2>Vote for Ward Chairperson</h2>
            <div class="candidate-list" id="ward-candidate">
              {% for candidate in ward_candidate %}
              <div class="candidate-card">
                <img src="{{ candidate.profile_picture.url }}" alt="Profile Picture" />
                <div class="details">
                  <h3>{{ candidate.first_name }} {{ candidate.last_name }}</h3>
                  <p><strong>Party: </strong>{{ candidate.political_party }}</p>
                  <p><strong>Position: </strong>{{ candidate.role }}</p>
                  <div class="radio-button">
                    <input
                      type="radio"
                      name="ward_chairperson_vote"
                      value="{{ candidate.email }}"
                    /><strong>Vote</strong>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="submit-button">
            <button type="submit" class="next-btn" id="submit-vote-btn" {% if not face_verified %}disabled{% endif %}>
                Submit Vote
                </button>

          </div>
          {% endif %}
        </div>
      </form>
    </section>
  </main>
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <h3>COMPANY</h3>
        <a href="#">Home</a>
        <a href="#">How It Works</a>
        <a href="#">Contact Us</a>
      </div>
      <div class="footer-section">
        <h3>LEGAL</h3>
        <a href="#">Terms of Service</a>
        <a href="#">Privacy Policy</a>
      </div>
      <div class="footer-section">
        <h3>ABOUT US</h3>
        <a href="#">Testimonials</a>
        <a href="#">Partners</a>
        <a href="#">Support Us</a>
      </div>
      <div class="footer-section">
        <h3>Contact Us</h3>
        <a href="mailto:abcd@gmail.com">abcd@gmail.com</a>
        <p>97789945551</p>
      </div>
    </div>
    <div class="social-icons">
      <a href="#"><i class="fab fa-twitter"></i></a>
      <a href="#"><i class="fas fa-peace"></i></a>
      <a href="#"><i class="fab fa-linkedin"></i></a>
    </div>
    <p>© 2024 OVC, Inc. All Rights Reserved.</p>
  </footer>

  <script src="{% static 'myapp/js/face_detection.js' %}"></script>
  <script src="{% static 'myapp/js/profilesdropdown.js' %}"></script>
  <script src="{% static 'myapp/js/navs.js' %}"></script>
  <script src="{% static 'myapp/js/alert.js' %}"></script>
  <script>
  function showToast(message, type = "info") {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.backgroundColor = type === "success" ? "#4CAF50" : type === "error" ? "#f44336" : "#333";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "8px";
    toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
    toast.style.zIndex = "9999";
    toast.style.opacity = "0";
    toast.style.transition = "opacity 0.3s ease";
    document.body.appendChild(toast);
    setTimeout(() => (toast.style.opacity = "1"), 50);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const contractAddress = "0x96283B521509b8409a33e51109B0Ef314b2d1B38";
const contractABI =[
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_voterAddress",
				"type": "address"
			},
			{
				"internalType": "bytes32",
				"name": "_descriptorHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "_uc",
				"type": "string"
			}
		],
		"name": "acceptKycAndStoreFaceHash",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "enum AdvancedVoting.Category",
				"name": "_category",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "_uc",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_candidate",
				"type": "address"
			}
		],
		"name": "addCandidate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "candidateId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "enum AdvancedVoting.Category",
				"name": "category",
				"type": "uint8"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "uc",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "candidate",
				"type": "address"
			}
		],
		"name": "CandidateAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "voter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bytes32",
				"name": "faceHash",
				"type": "bytes32"
			}
		],
		"name": "KYCAcceptedAndDataStored",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "manager",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			}
		],
		"name": "ManageMange",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_manager",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "_status",
				"type": "bool"
			}
		],
		"name": "managerManage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_startTime",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_endTime",
				"type": "uint256"
			}
		],
		"name": "setVotingSchedule",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnerShip",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "_newOwner",
				"type": "address"
			}
		],
		"name": "TransferOwneship",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "_candidateIds",
				"type": "address[]"
			}
		],
		"name": "vote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "voter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address[]",
				"name": "votes",
				"type": "address[]"
			}
		],
		"name": "Voted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "startTime",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "endTime",
				"type": "uint256"
			}
		],
		"name": "VotingScheduleSet",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "candidateCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "candidates",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "enum AdvancedVoting.Category",
				"name": "category",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "uc",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "voteCount",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "candidate",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "candidatesAdd",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "endTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "faceHashes",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_candidateId",
				"type": "address"
			}
		],
		"name": "getCandidate",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "enum AdvancedVoting.Category",
				"name": "",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "voter",
				"type": "address"
			}
		],
		"name": "getFaceHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getWinners",
		"outputs": [
			{
				"internalType": "string",
				"name": "results",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isCandidate",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isManager",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isVotingFinalized",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "scheduleSet",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "startTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "voters",
		"outputs": [
			{
				"internalType": "bool",
				"name": "hasVoted",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "isWhitelisted",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "uc",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "voter",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
 
const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();

const contract = new ethers.Contract(contractAddress, contractABI, signer);

  // ⏱ Check voting time
  try {
    const currentTime = Math.floor(Date.now() / 1000);
    const startTime = Number(await contract.startTime());
    const endTime = Number(await contract.endTime());

    console.log("Voting Schedule:", { currentTime, startTime, endTime });

    if (currentTime < startTime) {
      document.getElementById("voting-status-message").textContent =
        "Your KYC is verified, but voting has not started yet.";
      document.getElementById("vote-form").style.display = "none";
    } else if (currentTime > endTime) {
      document.getElementById("voting-status-message").textContent =
        "Voting has ended. Please check the results.";
      document.getElementById("vote-form").style.display = "none";
    } else {
      document.getElementById("voting-status-message").textContent = "";
      document.getElementById("vote-form").style.display = "block";
    }
  } catch (err) {
    console.error("Error fetching voting times:", err);
    showToast("Failed to check voting schedule.", "error");
  }

  const voteForm = document.getElementById("vote-form");
  const csrfToken = voteForm.querySelector('input[name="csrfmiddlewaretoken"]').value;
  const verifyFaceBtn = document.getElementById("verify-face-btn");
  const submitVoteBtn = document.getElementById("submit-vote-btn");

  // 👁 Load face-api models
  try {
    const modelsLoaded = await loadFaceApiModels();
    if (!modelsLoaded) throw new Error("Face-api models not loaded.");
    console.log("face-api.js models loaded.");
  } catch (error) {
    console.error("Model load error:", error);
    showToast("Facial recognition initialization failed.", "error");
    submitVoteBtn.disabled = true;
    return;
  }

  // 🎥 Verify Face Button
  verifyFaceBtn.addEventListener("click", async () => {
    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const webcam = document.getElementById("webcam");
      const canvas = document.getElementById("canvas");

      if (!webcam || !canvas) {
        showToast("Webcam or canvas missing.", "error");
        return;
      }

      webcam.srcObject = stream;
      showToast("Keep your face steady for 3 seconds...");
      await new Promise((res) => setTimeout(res, 3000));

      await captureLiveDescriptor(webcam, canvas, "live-descriptor");
      const liveDescriptor = document.getElementById("live-descriptor").value;
      stream.getTracks().forEach((track) => track.stop());

      if (!liveDescriptor) {
        showToast("No face detected. Try again.", "error");
        return;
      }

      const response = await fetch("{% url 'verify_face' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ live_descriptor: JSON.parse(liveDescriptor) }),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.message || "Face verification failed.");

      showToast("Facial verification successful!", "success");
      submitVoteBtn.disabled = false;

    } catch (error) {
      console.error("Verification error:", error);
      showToast(error.message || "Verification failed.", "error");
      stream?.getTracks().forEach((track) => track.stop());
      submitVoteBtn.disabled = true;
    }
  });

  // 🗳 Submit Vote Form
  voteForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitVoteBtn.disabled = true;

    try {
      await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();
      const contract = new ethers.Contract(contractAddress, contractABI, signer);

      const mp = voteForm.querySelector('input[name="mp_vote"]:checked')?.value;
      const mayor = voteForm.querySelector('input[name="mayor_vote"]:checked')?.value;
      const deputy = voteForm.querySelector('input[name="deputy_mayor_vote"]:checked')?.value;
      const ward = voteForm.querySelector('input[name="ward_chairperson_vote"]:checked')?.value;

      if (!mp || !mayor || !deputy || !ward) {
        showToast("Please select candidates for all roles.", "error");
        submitVoteBtn.disabled = false;
        return;
      }

      const response = await fetch("/get_candidate_addresses/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ mp, mayor, deputy, ward }),
      });

      const data = await response.json();
      if (!data.success || !Array.isArray(data.addresses)) {
        throw new Error("Could not fetch candidate addresses.");
      }

      const tx = await contract.vote(data.addresses);
      showToast("Vote transaction sent. Waiting for confirmation...", "info");
      await tx.wait();

      showToast("Vote cast successfully!", "success");
      voteForm.submit(); // ✅ Save off-chain record in Django

    } catch (err) {
      console.error("Vote submission error:", err);
      showToast(err.message || "Blockchain voting failed.", "error");
      submitVoteBtn.disabled = false;
    }
  });
});
</script>



</body>
</html>
